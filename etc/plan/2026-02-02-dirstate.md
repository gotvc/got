# Dirstate plan: by_got, filtering iterator, and dir-metadata noise

## Scope
Minimal changes focused on:
1. Add `by_got` to the `dirstate` table.
2. Add a filtered iterator in `gotwc` that applies tracking spans to DB iteration.
3. Ignore noisy directory metadata in `ForEachDirty`.

No preflight export changes. No redesign of status semantics.

---

## 1) Minimal `by_got` change to the database

### Goal
Track whether a `dirstate` entry was written by export/checkout (`by_got = true`) vs written after an explicit import (`by_got = false`).

### Proposed schema change
Add a column:
- `by_got INTEGER NOT NULL DEFAULT 0`

### Migration notes
- Add a new migration file in `gotwc/internal/dbmig` to `ALTER TABLE dirstate` and add the column.
- Ensure default is `0` so existing rows are treated as user-imported (non-Got-written).
- If needed, add a backfill step for any rows known to be export-only, but minimal plan assumes default.

### Code changes
- Update `porting.FileInfo` to include `ByGot bool`.
- Update DB read/write helpers:
  - `PutInfo`: write `by_got`.
  - `GetInfo`/`scanInfo`: read `by_got`.
  - `NewDBInfoIterator`: select `by_got`.

### Call sites to set `by_got`
- Exporter: when `exportFile` / `exportDir` writes to disk, set `ByGot = true` in `PutInfo`.
- Importer: when `ImportFile` / `ImportPath` writes to DB, set `ByGot = false`.
- Directory metadata: maintain `ByGot` for dirs (exported dirs should set true, imported dirs false).

---

## 2) Add filtered iterator wrapping DB iterator to apply tracking spans

### Goal
Ensure DB iteration respects the current tracking spans so stale or untracked paths do not surface as dirty.

### Proposed change
Add a wrapper in `gotwc`:
- `func (wc *WC) newFilteredDBInfoIterator(ctx, db) streams.Iterator[porting.FileInfo]`
  - internally calls `db.NewInfoIterator()`
  - filters entries using current tracking spans
  - excludes `.got` paths

### Integration
- Update `newUnknownIterator` to use the filtered DB iterator (instead of the raw DB iterator).
- The filesystem iterator already uses the filtered FS, so the join becomes consistent.

### Notes
- This avoids stale DB entries from old tracking prefixes without mutating the DB.
- If tracking changes frequently, consider later cleanup, but not in this plan.

---

## 3) Ignore noisy directory metadata in `ForEachDirty`

### Goal
Directories should not be marked dirty due to `modtime` changes that occur when a child changes.

### Proposed logic
When comparing DB info vs filesystem info:
- If the path is a directory, **ignore modtime and size** changes.
- Only consider:
  - existence (missing vs present)
  - mode changes (permissions)
  - type changes (file vs dir)

### Implementation sketch
- Add a helper, e.g. `HasChangedDirAware(a, b *FileInfo) bool`
  - If either is dir: compare type/mode only.
  - Else: keep existing `HasChanged` (mode + size + modtime).
- Use this helper in `newUnknownIterator` (or near its filter).
- Ensure directory detection is based on `Mode` or explicit `IsDir()` helper on `FileInfo`.

---

## Tests (table-driven only)

### New tests to add
1. **Filtered DB iterator respects tracking spans**
   - Setup:
     - tracking spans: `["a/"]`
     - DB entries: `a/file.txt`, `b/file.txt`
   - Expect: only `a/file.txt` participates in unknown/dirty.

2. **Directory metadata noise ignored**
   - Table-driven cases:
     - Same dir mode, modtime changed → NOT dirty.
     - Dir mode changed → dirty.
     - Dir replaced by file → dirty.
     - File replaced by dir → dirty.
   - Ensure tests cover both DB->FS and FS->DB comparisons.

3. **ByGot persistence**
   - Table-driven cases:
     - Export path writes `by_got = true`.
     - Import path writes `by_got = false`.
   - Validate stored value with `GetInfo`.

### Test format requirement
- All tests must be **table-driven** with named cases.
- Use subtests (`t.Run`) to enumerate cases.
- For directory-noise tests, define a small helper to build `FileInfo` with mode/type.

---

## Out of scope
- Preflight export to avoid partial writes.
- Tracking rev or other new columns beyond `by_got`.
- Refactoring `ForEachDirty` semantics or staged/unstaged separation.

---

## Acceptance checklist
- `dirstate` schema includes `by_got`, and DB read/write paths handle it.
- DB iteration is filtered by tracking spans and `.got` is excluded.
- Directory modtime changes do not produce dirty entries.
- Table-driven tests cover filtering, directory noise, and `by_got` storage.
